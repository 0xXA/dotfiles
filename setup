#!/data/data/com.termux/files/usr/bin/bash

shopt -s extglob

[[ -e `pwd`/setup.cfg ]] && {
	set -a
	. `pwd`/setup.cfg
	set +a
} || exit 1

function install_packages {
	local packages=( 'binutils' 'coreutils' 'curl' 'dirmngr' 'file' 'gdb' 'git' 'gnupg' 'grep' 'jq' 'make' 'p7zip' 'patch' 'rclone' 'rsync' 'sed' 'silversearcher-ag' 'strace' 'tar' 'termux-api' 'termux-exec' 'tree' 'util-linux' 'unstable-repo' 'unzip' 'vim' 'wget' 'x11-repo' 'xz-utils' 'yasm' 'zip' )

	[[ -n "`dpkg --get-selections | xargs apt-cache policy {} | grep -1 Installed | sed -r 's/(:|Installed: |Candidate: )//' | uniq -u | tac | sed '/--/I,+1 d' | tac | sed '$d' | sed -n 1~2p | xargs`" ]] && {
		apt-get update;
		apt-get upgrade;
	}
	
	if ! dpkg --status "${packages[@]}" qemu-system-x86_64 qemu-user-x86_64  > /dev/null 2>&1; then
		apt-get install "${packages[@]}"
		[[ -n "${install_qemu}" ]] && \
			apt-get install qemu-system-x86_64 qemu-user-x86_64
	fi
}

function install_gpgkeys {
	gpg_keys=( 'github.asc' )
	for gpgk in "${gpg_keys[@]}"; do \
		gpg --import `pwd`/keys/$gpgk; \
	done
	unset gpg_keys
}

function install_confs {
	cp `pwd`/.gitconfig ~/.gitconfig
	cp `pwd`/shells/bash/@(.|)[a-zA-Z]* ~/
}

function install_confs {
	cp `pwd`/.gitconfig ~/.gitconfig

	local files=(.bashrc .functions .variables profile)
	for file in "${FILES[@]}"; do
		[[ ${file} = "profile" ]] && {
			cp `pwd`/shells/bash/$file $PREFIX/etc/
		} || cp `pwd`/shells/bash/$file ~/
        done
	unset files file

	cp -r `pwd`/.termux/ ~/
	[[ -e $PREFIX/etc/motd ]] && \
		rm $PREFIX/etc/motd
}

[[ -n "${install_packages}" ]] && install_packages
[[ -n "${install_confs}" ]] && install_confs
[[ -n "${install_gpgkeys}" ]] && install_gpgkeys
